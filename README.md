# Автоматическое выполнение системных действий
### Лабораторная работа #2
[[презентация 1]](https://www.dropbox.com/s/e2w4dij69yt45xw/%D0%9B%D0%B0%D0%B1%D0%BE%D1%80%D0%B0%D1%82%D0%BE%D1%80%D0%BD%D0%B0%D1%8F%20%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%B0%202.pptx?dl=0) [[презентация 2]](https://www.dropbox.com/s/lehuu7pg8sc3hb7/%D0%9B%D0%B0%D0%B1%D0%BE%D1%80%D0%B0%D1%82%D0%BE%D1%80%D0%BD%D0%B0%D1%8F%20%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%B0%202%20%282%29.pptx?dl=0) [[презентация 3]](https://www.dropbox.com/s/oz9gfjvnw7h43rv/%D0%9B%D0%B0%D0%B1%D0%BE%D1%80%D0%B0%D1%82%D0%BE%D1%80%D0%BD%D0%B0%D1%8F%20%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%B0%202%20%283%29.pptx?dl=0) [[репозиторий]](https://github.com/Andrew414/servicetask)

## Условие (1)
Необходимо написать приложение, которое может запускаться автоматически при старте системы. Это может быть служба Windows/демон Unix или обычное приложение, запускаемое автоматически средствами ОС (планировщиком задач, списком автозагрузки и др).

У приложения должен быть предоставить установщик, который может устанавливать (настраивать автоматический запуск) и удалять (отменять автоматический запуск) приложение. Установщиком может быть отдельный файл, скрипт или просто опция командной строки.

Приложение должно следить за состоянием сетевых адаптеров. В том случае, если есть включенный проводной адаптер, оно должна отключать все присутствующие беспроводные адаптеры.

Как только проводной адаптер становится неактивным, или если программа удаляется, все выключенные этой программой адаптеры должны быть включены. Поскольку в современных ноутбуках может не быть LAN-порта, в качестве проводного можно использовать виртуальный адаптер (VirtualBox, VMWare) или любой другой адаптер.

## Условие (2)
Необходимо написать приложение, которое может запускаться автоматически при старте системы. Это может быть служба Windows/демон Unix или обычное приложение, запускаемое автоматически средствами ОС (планировщиком задач, списком автозагрузки и др).

У приложения должен быть предоставить установщик, который может устанавливать (настраивать автоматический запуск) и удалять (отменять автоматический запуск) приложение. Установщиком может быть отдельный файл, скрипт или просто опция командной строки.

Приложение должно следить за двумя файлами (каталогами) в ОС. Пути к файлам должны быть конфигурируемыми. Как только изменяется владелец/группа-владелец одного файла, программа должна соответственно изменить владельца/группу-владельца второго файла. Поскольку в Windows работа с владельцем и группой-владельцем не применяется широко (отсутствуют удобные инструменты для просмотра и изменения владельца и группы-владельца, требуются права администратора для изменения и др), то вместо владельца и группы можно изменять ACL.

## Условие (3)

Необходимо написать приложение, которое может запускаться автоматически при старте системы. Это может быть служба Windows/демон Unix или обычное приложение, запускаемое автоматически средствами ОС (планировщиком задач, списком автозагрузки и др).

У приложения должен быть предоставить установщик, который может устанавливать (настраивать автоматический запуск) и удалять (отменять автоматический запуск) приложение. Установщиком может быть отдельный файл, скрипт или просто опция командной строки.

Приложение должно следить за файлом в ОС. Путь к файлу должен быть конфигурируемым. 
Как только приложение запускается или как только изменяется содержимое файла, приложение должно дописывать в конец другого файла (лога) информацию о текущем времени и md5-хеше первого файла. Путь к логу тоже должен быть конфигурируемым.

Пример лога:
```
[2017.10.17 11:17:25] f8aceb05530a695188a262a128592758
[2017.10.17 11:17:42] 7e113b24ec41af7d9f8e59614171c6b8
[2017.10.17 11:18:04] 48a6731b2193276e86adcbd0dd422d79
```

### Дополнительная информация

###### Службы Windows и демоны Unix
Службы ОС Windows (англ. Windows Service, сервисы) — приложения, автоматически (если настроено) запускаемые системой при запуске Windows и выполняющиеся вне зависимости от статуса пользователя. 

Демон — компьютерная программа в системах UNIX, запускаемая самой системой и работающая в фоновом режиме без прямого взаимодействия с пользователем. Демоны обычно запускаются во время загрузки системы.

###### Запуск служб Windows
Службы запускаются в адресном пространстве приложения-контейнера и взаимодействуют с системой только через callback-функции. Функция `main` служит только для запуска обработчика сервиса. Для запуска диспетчера сервисов используется функция `StartServiceCtrlDispatcher`, которая принимает массив неопределенной длины, каждый элемент которого содержит имя сервиса и адрес соответствующей точки входа.

Точка входа в сервис должна:
* Запускать обработчик управляющих команд (с помощью функции `RegisterServiceCtrlHandler`)
* Устанавливать и изменять состояние сервиса
* Выполнять работу сервиса в соответствии с состоянием
* Освобождать ресурсы при переходе в состояние STOPPED

Возможные управляющие команды:
* SERVICE_CONTROL_STOP — остановить сервис; 
* SERVICE_CONTROL_PAUSE — приостановить сервис; 
* SERVICE_CONTROL_CONTINUE — возобновить сервис; 
* SERVICE_CONTROL_INTERROGATE — обновить состояние сервиса; 
* SERVICE_CONTROL_SHUTDOWN — закончить работу сервиса.
* Коды, определенные пользователем – 128-255


###### Дополнительные ссылки
Работа с сервисами Windows:
* Курс "Системное программирование", лекция 9
* Книга "Внутреннее устройство Windows", глава 4

Реализация задач лабораторной:
* Функции для работы с сетью в Windows https://msdn.microsoft.com/en-us/library/windows/desktop/aa366071(v=vs.85).aspx 
* Функции для работы с сетью в Unix http://man7.org/linux/man-pages/man3/getifaddrs.3.html
* Функции для работы с ACL в Windows https://msdn.microsoft.com/ru-ru/library/windows/desktop/aa375742(v=vs.85).aspx#low_level_access_control_functions 
* Функции для работы с правами файлов в Unix https://support.dce.felk.cvut.cz/pos/os_api/unix-4.html 
* Функции для работы с уведомлениями о событиях в файловой системе в Windows https://msdn.microsoft.com/ru-ru/library/windows/desktop/aa365465(v=vs.85).aspx
* Функции для работы с уведомлениями о событиях в файловой системе в Unix http://man7.org/linux/man-pages/man7/inotify.7.html
* Реализации MD5 https://www.ietf.org/rfc/rfc1321.txt https://rosettacode.org/wiki/MD5/Implementation 

### Дополнительные требования
Программа должна быть написана с использованием общепринятого [**стандарта**](https://ru.wikipedia.org/wiki/Стандарт_оформления_кода). Если для выбранного языка есть один такой стандарт, используйте его, иначе выберите любой для своего языка программирования и укажите в комментариях к Pull Request, какой именно стандарт выбран.

### Дополнительные задания
Три задачи:
* Реализовать программу как службу Windows/демон Unix 
  * Запуск программы не должен производиться с помощью автозагрузки или планировщиков
* Реализовать подписку программы на уведомления о системных событиях
  * Изменения в сетевом окружении (Условие 1)
  * Изменения прав файлов (Условие 2)
  * Изменения содержимого файлов (Условие 3)
* Реализовать установщик в _общепринятом_ виде 
  * В Windows - как набор с диалогами (msi или аналогичный метод) 
  * В Unix - как пакет (make install либо unix-пакеты)

### Репозиторий
[Репозиторий](https://github.com/Andrew414/servicetask) содержит главную страницу [`README.md`](https://github.com/Andrew414/servicetask/blob/master/README.md) и девять персональных каталогов. Необходимо сделать копию (fork) репозитория и вносить все изменения только в свой персональный каталог. Все эти каталоги содержат пустой файл `.gitignore`, куда нужно вписать все временные файлы из лабораторной работы. Остальные файлы должны быть файлами кода (в т.ч. проекта).

### Сдача лабораторной работы
Можно выбрать любой язык программирования, IDE и фреймворки/библиотеки. Если для работы нужны какие-то нестандартные конфигурации или ПО, предоставьте инструкцию по настройке среды.

Сдача через **Pull Request** из вашего клонированного репозитория. Pull Request должен содержать код, файлы проекта и информационные файлы. Результаты сборок и временные файлы должны быть исключены из коммитов.

### Оценка
Максимум за лабораторную работу - **10 баллов**.
- **4 балла** за главную задачу
- **3 балла**, если работа сделана вовремя
- **1 балл** за реализацию лабораторной как *сервиса*/*демона*
- **1 балл** за реализацию подписки на *системные уведомления*
- **1 балл** за реализацию *установщика в общепринятом виде*

### Сроки
На выполнение лабораторной дается 4 недели (3 октября - 31 октября). Лабораторная работа считается принятой, когда Pull Request переходит в состояние "approved". Дни, в течение которых лабораторная была на проверке, не учитываются.
![ ](https://i.snag.gy/lPOzf7.jpg)

Например, если вы сдаете лабораторную через две недели после выдачи (17 октября), но комментарии даны только через неделю (24 октября), у вас все еще будет две недели на устранение недочетов, все дни после коммита до получения ревью не считаются.

### Желаю удачи!
